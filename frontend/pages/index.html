<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - Social Community</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./../assets/css/style.css">

    <style>
        .post-container {
            max-height: 300px;
            /* Limit post size */
            overflow: hidden;
            /* Hide overflow content */
            position: relative;
        }

        .post-container.expanded {
            max-height: none;
            /* Expand when needed */
        }

        .read-more {
            display: block;
            text-align: center;
            color: blue;
            cursor: pointer;
            margin-top: 10px;
        }

        #postshow {
            /* max-height: 200px; */
            /* Limit image height */
            width: 100%px;
            /* Make image responsive */
            object-fit: contain;
            /* Crop the image */
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-md fixed w-full top-0 z-50">
        <div class="max-w-10xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <button id="menuBtn" class="md:hidden p-2 rounded-md hover:bg-gray-100">
                        <i class="bi bi-list text-2xl"></i>
                    </button>
                    <a href="index.html"><img src="./../assets/images/GrowLinky-removebg-preview crop.png"
                            class="logo"></a>
                </div>

                <div class="flex items-center space-x-4">
                    <button class="p-2 rounded-full hover:bg-gray-100" title="Home">
                        <a href="index.html"><i class="bi bi-house-door text-xl"></a></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100" title="Groups">
                        <a href="friends.html"><i class="bi bi-people text-xl"></i></a> </i>
                    </button>
                    <!-- <button class="p-2 rounded-full hover:bg-gray-100 relative" title="Messages">
                            <i class="bi bi-chat text-xl"></i>
                            <span class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">3</span>
                        </button>
                        <button class="p-2 rounded-full hover:bg-gray-100" title="Notifications">
                            <i class="bi bi-bell text-xl"></i> -->
                    </button>
                    <button><a href="settings.html"
                            class="flex items-center space-x-2 p-2 hover:bg-gray-100 rounded-lg"><i
                                class="bi bi-gear text-xl"></a></i></button>
                    <a href="profile.html"><img
                            src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=80&h=80&fit=crop"
                            class="w-10 h-10 rounded-full"></a>
                    <a href="login_signup.html"> <button
                            class="btn-login px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition">Login</button></a>


                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex pt-16  w-full">
        <!-- Profile Sidebar -->
        <div class="col-span-6 col-start-4 px-4 py-6 m-6">
            <div class="sidebar col-span-3 bg-white rounded-lg border-r p-4  h-full overflow-y-auto">
                <div class="flex flex-col items-center mb-6">
                    <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=80&h=80&fit=crop"
                        class="w-20 h-20 rounded-full mb-2">
                    <h3 class="font-semibold text-lg">John Doe</h3>
                    <p class="text-gray-500">@johndoe</p>
                    <a href="profile.html">
                        <button
                            class="mt-4 w-40 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Edit
                            profile</button></a>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-semibold mb-2">Quick Stats</h4>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center">
                            <div class="font-semibold">250</div>
                            <div class="text-sm text-gray-500">Posts</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">12.4K</div>
                            <div class="text-sm text-gray-500">Followers</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">1.2K</div>
                            <div class="text-sm text-gray-500">Following</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Main Feed Container with Fixed Height -->
        <div class="col-span-6 col-start-4 px-4 py-6 m-6 max-w-2xl">
            <!-- Search Bar -->
            <div class="relative mb-6">
                <input type="text" placeholder="Search..."
                    class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                <i class="bi bi-search absolute right-3 top-2.5 text-gray-400"></i>
            </div>

            <!-- Posts Feed with Fixed Height and Scroll -->
            <div class="space-y-6 max-h-[600px] overflow-y-auto pr-2" id="postsFeed">
                <!-- Post Creator -->
                <div class="post-creator bg-white rounded-lg shadow p-4">
                    <div class="post-input-container flex space-x-3">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=80&h=80&fit=crop"
                            class="w-10 h-10 rounded-full" alt="User avatar">
                        <textarea id="postText" placeholder="What's on your mind?"
                            class="w-full p-2 border rounded-lg resize-none focus:outline-none focus:border-blue-500"></textarea>
                    </div>

                    <div class="image-upload-section mt-4">
                        <label for="imageUpload"
                            class="upload-button inline-flex items-center px-4 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <i class="bi bi-image mr-2"></i>
                            <span>Upload Image</span>
                        </label>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden"
                            onchange="handleImageUpload(event)">

                        <div id="imagePreviewContainer" class="hidden mt-4 relative">
                            <img id="imagePreview" class="max-h-60 rounded-lg w-full object-cover" src="" alt="Preview">
                            <button onclick="removeImage()"
                                class="absolute top-2 right-2 bg-white rounded-full p-1 shadow hover:bg-gray-100">Ã—</button>
                        </div>
                    </div>

                    <div class="post-actions mt-4 flex justify-end">
                        <button onclick="submitPost()"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Post</button>
                    </div>
                </div>

                <!-- Sample Post -->
                <div class="bg-white rounded-lg shadow p-4" id="postshow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex space-x-3">
                            <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=80&h=80&fit=crop"
                                class="w-10 h-10 rounded-full">
                            <div>
                                <h4 class="font-semibold">Sarah Wilson</h4>
                                <p class="text-sm text-gray-500">2 hours ago</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-gray-600">
                            <i class="bi bi-three-dots"></i>
                        </button>
                    </div>
                    <p class="mb-4">Just finished an amazing workshop on sustainable living! ðŸŒ± Can't wait to implement
                        these new ideas.</p>
                    <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?w=800&h=400&fit=crop"
                        class="rounded-lg mb-4 w-full object-cover max-h-96">
                    <div class="flex items-center justify-between pt-4 border-t">
                        <button class="flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                            <i class="bi bi-heart"></i>
                            <span>245</span>
                        </button>
                        <button class="flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                            <i class="bi bi-chat"></i>
                            <span>42</span>
                        </button>
                        <button class="flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                            <i class="bi bi-share"></i>
                            <span>12</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* Custom scrollbar styles */
            .space-y-6::-webkit-scrollbar {
                width: 6px;
            }

            .space-y-6::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            .space-y-6::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }

            .space-y-6::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            /* For Firefox */
            .space-y-6 {
                scrollbar-width: thin;
                scrollbar-color: #888 #f1f1f1;
            }
        </style>

        <!-- Right Sidebar -->
        <!-- <div class="col-span-12 p-4 m-6"> -->
        <!-- Search Bar -->
        <!-- <div class="relative mb-6">
                    <input type="text" placeholder="Search..." class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                    <i class="bi bi-search absolute right-3 top-2.5 text-gray-400"></i>
                </div> -->

        <!-- Trending Topics -->
        <!-- <div class="bg-white rounded-lg shadow p-4 mb-6 w-full">
                    <h3 class="font-semibold mb-4">Trending Topics</h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="bg-green-100 rounded-lg p-2 text-green-600">
                                <i class="bi bi-hash text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold">#sustainability</h4>
                                <p class="text-sm text-gray-500">2.5K posts</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="bg-green-100 rounded-lg p-2 text-green-600">
                                <i class="bi bi-hash text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold">#community</h4>
                                <p class="text-sm text-gray-500">1.8K posts</p>
                            </div>
                        </div>
                    </div>
                </div> -->
        <!-- login
                <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 w-96">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold">Login</h3>
                            <button onclick="toggleModal('loginModal')" class="text-gray-400 hover:text-gray-600">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Login</button>
                            <div class="text-center">
                                <a href="#" class="text-sm text-blue-600 hover:underline">Forgot password?</a>
                            </div>
                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">Or New user</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sgap-4">
                                <button onclick="toggleModal('Registermodule'),toggleModal('loginModal')" type="button" class="flex items-center justify-center space-x-2 border rounded-lg px-4 py-2 hover:bg-gray-50">

                                    <span>Register</span>
                                </button>

                            </div>
                        </form>
                    </div>
                </div>
                Register
                <div id="Registermodule" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 w-96">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold">Register</h3>
                            <button onclick="toggleModal('Registermodule')"   class="text-gray-400 hover:text-gray-600">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Username</label>
                                <input type="email" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Sid NO.</label>
                                <input type="email" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700"> confirm Password</label>
                                <input type="password" required class="mt-1 w-full px-4 py-2 rounded-lg border focus:outline-none focus:border-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Register</button>

                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">Or already have</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sgap-4">
                                <button onclick="toggleModal('loginModal'),toggleModal('Registermodule')" type="button" class="flex items-center justify-center space-x-2 border rounded-lg px-4 py-2 hover:bg-gray-50">

                                    <span>login</span>
                                </button>

                            </div>
                        </form>
                    </div>
                </div> -->


        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script src="../assets/js/script.js"></script>
        <script>

            document.getElementById("imageUpload").addEventListener("click", function () {
                this.value = "";  // Clears the input so that selecting the same file will trigger onchange
            });


            function handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imageBase64 = e.target.result;
                        localStorage.setItem("postImage", imageBase64); // Store in local storage
                        document.getElementById("imagePreview").src = imageBase64;
                        document.getElementById("imagePreviewContainer").classList.remove("hidden");
                    };
                    reader.readAsDataURL(file);
                }
                else {
                    // If no file is selected, clear the preview
                    removeImage();
                }
            }

            function removeImage() {
                localStorage.removeItem("postImage");
                document.getElementById("imagePreview").src = "";
                document.getElementById("imageUpload").value = "";
                document.getElementById("imagePreviewContainer").classList.add("hidden");
            }

            const reader = new FileReader();


            function submitPost() {
                const postText = document.getElementById("postText").value.trim();
                let postImage = localStorage.getItem("postImage"); // Get image from local storage
                let token = localStorage.getItem("access_token");

                if (!postText) {
                    alert("Post cannot be empty!");
                    return;
                }

                // **Fix: If the image preview is empty, do not send the previous image**
                const imagePreview = document.getElementById("imagePreview").src;
                if (!imagePreview || imagePreview.includes("data:image") === false) {
                    postImage = ""; // Ensure previous image is not sent
                    localStorage.removeItem("postImage");
                }

                console.log(postImage);
                $.ajax({
                    url: "http://127.0.0.1:5000/api/posts",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        post_caption: postText,
                        post_image: postImage  // Now it will send `null` if no image is selected
                    }),
                    headers: {
                        "Authorization": `Bearer ${token}`
                    },
                    success: function (response) {
                        alert("Post created successfully!");
                        localStorage.removeItem("postImage"); // Clear stored image
                        document.getElementById("postText").value = "";
                        removeImage();
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            console.log("Access token expired, refreshing...");
                            refreshAccessToken();
                        } else {
                            console.error("Request failed:", xhr.responseText);
                        }
                    }
                });
            }



            // fetch post

            $(document).ready(function () {
                fetchPosts();
            });

            function fetchPosts() {
                let token = localStorage.getItem("access_token");
                $.ajax({
                    url: "http://127.0.0.1:5000/api/posts/all",
                    type: "GET",
                    dataType: "json",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    },
                    success: function (data) {
                        renderPosts(data);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching posts:", error);
                    }
                });
            }



            function renderPosts(posts) {
                let postsFeed = $("#postshow");
                postsFeed.empty(); // Clear existing posts

                posts.forEach(post => {
                    if (post.is_deleted) return; // Skip deleted posts

                    // âœ… Fix the image path properly
                    let imagePath = post.post_image ? post.post_image.replace(/\\/g, "/") : "";
                    let fullImagePath = imagePath ? `http://127.0.0.1:49877/backend/${imagePath}` : ""; // Adjust based on your static files setup
                    console.log(post);

                    let postHtml = `
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm text-gray-500">${post.user_name}</p>
                            <p class="text-sm text-gray-500">${timeAgo(post.created_at)}</p>
                        </div>
                    </div>
                    <p class="mb-4">${post.post_caption || "No caption provided"}</p>
                    ${fullImagePath ? `<img src="${fullImagePath}" class="rounded-lg mb-4 w-full h-auto">` : ""}
                    <div class="flex items-center justify-between pt-4 border-t">
                        <div class="px-4 py-2 flex items-center justify-around border-t border-gray-100">
                    <button onclick="handleLike(${post.post_id})"
                            class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors duration-200 ${post.has_liked ? 'text-red-500' : 'text-gray-700'}">
                        <i class="bi bi-heart${post.has_liked ? '-fill' : ''} text-xl"></i>
                        <span class="font-medium">Like</span>
                    </button>
                    <button onclick="toggleComments(${post.post_id})"
                            class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        <i class="bi bi-chat text-xl text-gray-700"></i>
                        <span class="font-medium">Comment</span>
                    </button>
                    </div>
                </div>
            `;

                    postsFeed.append(postHtml);
                });

                $(".like-btn").click(function () {
                    let postId = $(this).data("post-id");
                    let likeButton = $(this);
                    let likeCountSpan = likeButton.find(".like-count");

                    $.ajax({
                        url: "/likes",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ post_id: postId }),
                        headers: { Authorization: "Bearer " + localStorage.getItem("token") },
                        success: function (response) {
                            let currentLikes = parseInt(likeCountSpan.text());

                            if (likeButton.hasClass("text-red-500")) {
                                likeButton.removeClass("text-red-500").addClass("text-gray-700");
                                likeButton.find("i").removeClass("bi-heart-fill").addClass("bi-heart");
                                likeCountSpan.text(currentLikes - 1);
                            } else {
                                likeButton.addClass("text-red-500").removeClass("text-gray-700");
                                likeButton.find("i").addClass("bi-heart-fill").removeClass("bi-heart");
                                likeCountSpan.text(currentLikes + 1);
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.responseJSON.error || "Something went wrong!");
                        }
                    });
                });
            }




            function toggleComments(postId) {
                $(`#comments-${postId}`).slideToggle();
            }

            function timeAgo(timestamp) {
                let time = new Date(timestamp);
                let now = new Date();
                let diff = Math.floor((now - time) / 1000);

                if (diff < 60) return diff + " seconds ago";
                if (diff < 3600) return Math.floor(diff / 60) + " minutes ago";
                if (diff < 86400) return Math.floor(diff / 3600) + " hours ago";
                return Math.floor(diff / 86400) + " days ago";
            }

            function timeAgo(timestamp) {
                let time = new Date(timestamp);
                let now = new Date();
                let diff = Math.floor((now - time) / 1000);

                if (diff < 60) return diff + " seconds ago";
                if (diff < 3600) return Math.floor(diff / 60) + " minutes ago";
                if (diff < 86400) return Math.floor(diff / 3600) + " hours ago";
                return Math.floor(diff / 86400) + " days ago";
            }



            // like :



            $(document).ready(function () {
                $(".like-btn").click(function () {
                    console.log("Clicked")
                    let postId = $(this).data("post-id");
                    let likeButton = $(this);
                    let likeCountSpan = likeButton.find(".like-count");

                    $.ajax({
                        url: "http://127.0.0.1:5000/api/likes",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ post_id: postId }),
                        headers: { Authorization: "Bearer " + localStorage.getItem("token") },  // Ensure JWT token is passed
                        success: function (response) {
                            let currentLikes = parseInt(likeCountSpan.text());

                            if (likeButton.hasClass("text-red-500")) {
                                likeButton.removeClass("text-red-500").addClass("text-gray-700");
                                likeButton.find("i").removeClass("bi-heart-fill").addClass("bi-heart");
                                likeCountSpan.text(currentLikes - 1);
                            } else {
                                likeButton.addClass("text-red-500").removeClass("text-gray-700");
                                likeButton.find("i").addClass("bi-heart-fill").removeClass("bi-heart");
                                likeCountSpan.text(currentLikes + 1);
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.responseJSON.error || "Something went wrong!");
                        }
                    });
                });
            });


        </script>


</body>

</html>